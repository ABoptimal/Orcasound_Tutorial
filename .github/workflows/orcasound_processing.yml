name: Orcasound processing

on:
  # To run manually
  workflow_dispatch:

jobs:
  process:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2

    - name: Setup Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.x'

    - name: Install Python dependencies
      run: |
        python -m pip install -U pip
        python -m pip install -U setuptools wheel
        python -m pip install awscli matplotlib scipy

    - name: Get latest timestamp
      run: |
        aws --no-sign-request s3 cp s3://streaming-orcasound-net/rpi_bush_point/latest.txt .
        read -r timestamp<latest.txt
        echo "timestamp=$timestamp" >> $GITHUB_ENV

    - name: Get all files
      run: |
        aws --no-sign-request s3 sync s3://streaming-orcasound-net/rpi_bush_point/hls/${{ env.timestamp }}/ bush_point

    - name: Install ffmpeg
      run: |
        sudo apt-get update
        sudo apt-get install ffmpeg

    - name: Concat all files into one just for fun
      run: |
        ffmpeg -f -safe 0 concat -i <(for f in ./bush_point/*.ts; do echo "file '$PWD/$f'"; done) -c copy all.wav

    - name: Upload combined wav file
      uses: actions/upload-artifact@v2
      with:
        name: all.wav
        path: all.wav

    - name: Convert all files to .wav
      run: |
        for file in bush_point/*.ts; do ffmpeg -i "$file" "${file%.*}.wav"; done
    
    - name: Create spectrograms
      run: |
        python orcasound_processing.py

    - name: Upload spectrograms
      uses: actions/upload-artifact@v2
      with:
        name: Spectrograms
        path: |
          bush_point/*.png
